{% extends 'base.html.twig' %}

{% block body %}
   <div class="container">
    <div class="mb-3">
        <a href="{% if is_granted('ROLE_ADMIN') %}
                {{ path('app_system_display', {'id': system.id}) }}
            {% else %}
                {{ path('app_subscription') }}
            {% endif %}"
       class="btn btn-secondary">Back to Display System</a>
    </div>
    <h2 class="bg-info text-center text-white rounded-pill">Events for {{ system.name }}</h2>
    <div class="table-responsive">
    <table class="table table-bordered table-md" id="table" style="font-size: 13px">
    <thead class="bg-primary text-white">
        <tr>
            <th scope="col">Type</th>
            <th scope="col">Start Date</th>
            <th scope="col">End Date</th>
            <th scope="col">Info</th>
            <th scope="col">Created at</th>
            <th scope="col">Created by</th>
            {% if is_granted('ROLE_ADMIN') %}
                <th scope="col">Email body</th>
                <th scope="col">Actions</th>
                <th scope="col">Edit-Maintenance</th>
            {% endif %}
        </tr>
    </thead>
    <tbody>
      {% for event in events %}
        {% set isOldEvent = event.start < "now"|date %}
        <tr {% if isOldEvent %}class="table-secondary" disabled{% endif %}>
            <td>
                <span class="type-badge
                    {% if event.type == 'available' %}
                        bg-success text-white
                    {% elseif event.type == 'maintenance' %}
                        bg-warning
                    {% elseif event.type == 'incident' %}
                        bg-danger text-white
                    {% endif %}
                ">
                    {{ event.type }}
                </span>
            </td>
            <td>{{ event.start|date('Y-m-d H:i:s') }}</td>
            <td>
                {% if event.end %}
                    {{ event.end|date('Y-m-d H:i:s') }}
                {% else %}
                    Not resolved yet
                {% endif %}
            </td>
            <td>{{ event.info }}</td>
            <td>{{ event.createdAt|date('Y-m-d H:i:s') }}</td>
            <td>{{ event.creator.email }}</td>
            {% if is_granted('ROLE_ADMIN') %}
                <td>{{ event.email }}</td>
                <td>
                    {% if event.type == 'incident' and event.end|date('Y-m-d') == '9999-12-31' %}
                        <a href="{{ path('app_events_resolve_incident', {'id': event.id}) }}" class="btn btn-danger">Revoke Incident</a>
                    {% elseif event.type == 'incident' and event.end %}
                        <button class="btn btn-secondary" disabled>Resolved</button>
                    {% elseif event.type == 'available' %}
                        <button class="btn btn-success" disabled>Conclude</button>
                    {% elseif event.type == 'maintenance' %}
                        {% if event.start and event.end %}
                            <button class="btn btn-success" disabled>Concluded</button>
                        {% else %}
                            <a href="{{ path('app_events_change_to_available', {'id': event.id}) }}" class="btn btn-warning">Conclude</a>
                        {% endif %}
                    {% endif %}
                </td>

                <td>
                    <a href="{{ path('app_events_edit_maintenance', {'eventId': event.id}) }}" class="btn btn-primary">Edit</a>
                </td>
            {% endif %}
        </tr>
    {% endfor %}
    </tbody>
</table>
</div>
</div>



    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resolvedButtons = document.querySelectorAll('.btn-secondary[disabled]');
            resolvedButtons.forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                     // Check if the incident is resolved
                if (event.target.textContent === 'Resolved') {
                    alert('This incident is already resolved.');
                } else {
                    // Prompt the user for confirmation
                    const confirmed = confirm('Are you sure you want to perform this action?');
                    
                    if (confirmed) {
                        // Perform the action (you can replace this with your custom logic)
                        performCustomAction(event.target);
                        
                        // Update the button text to show the action has been performed
                        event.target.textContent = 'Action Performed';
                        event.target.classList.remove('btn-secondary');
                        event.target.classList.add('btn-success');
                    }
                }
            });
        });
        
        // Function to perform a custom action
        function performCustomAction(button) {
            // Example: You can make an AJAX request, update the UI, etc.
            // Here, we are just logging a message
            console.log('Custom action performed for button:', button);
        }
    });

    </script>
{% endblock %}

