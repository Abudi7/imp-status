{% extends 'base.html.twig' %}

{% block body %}
    <div class="container">
    <h2 class="bg-warning text-center rounded-pill ">Create New Maintenance Event</h2>
    {{ form_start(form) }}
    {{ form_row(form.system) }}
    {{ form_row(form.creator) }}
    {{ form_row(form.created_at) }}
    {{ form_row(form.info) }}
    {{ form_row(form.type) }}
    {{ form_row(form.start) }}
    {{ form_row(form.end) }}
    {{ form_row(form.emailtemplate, {'attr': {'class': 'template-select'}}) }}
    {{ form_row(form.email, {'attr': {'class': 'email-field'}}) }}
    {{ form_row(form.send_email) }}
    <button type="submit" class="btn btn-primary">Create Event</button>
    {{ form_end(form) }}
</div>

<script>
    // Add event listener to emailtemplate dropdown
    const templateSelect = document.querySelector('.template-select');
    const emailField = document.querySelector('.email-field');
    const systemName = '{{ form.vars.value.system.name }}'; // Store the value in a variable

    
    templateSelect.addEventListener('change', () => {
        const selectedTemplateId = templateSelect.value;
        if (selectedTemplateId) {
            fetch(`http://localhost:8080/public/template/${selectedTemplateId}/get-template-content/`)
                .then(response => response.text())
                .then(content => {
                    const filledContent = fillTemplatePlaceholders(content); // Replace placeholders
                    console.log(emailField)
                    console.log(`http://localhost:8080/public/template/${selectedTemplateId}/get-template-content/`)
                    emailField.value = filledContent; // Populate email textarea
                })
                .catch(error => {
                    console.error('Error fetching template content:', error);
                });
        } else {
            emailField.value = ''; // Clear email textarea if no template selected
        }
    });
    function fillTemplatePlaceholders(templateContent) {
    const placeholders = {
        system_name: systemName, // Replace with actual value
        maintenance_date: '{{ form.start.vars.value|date('d-M-Y') }}', // Replace with actual value
        start_time: '{{ form.start.vars.value|date('H:i d-M-Y') }}', // Replace with actual value
        end_time: '{{ form.vars.value.end|date('H:i d-M-Y') }}', // Replace with actual value
        responsible_person: '{{ form.vars.value.creator.email }}', // Replace with actual value
    };

    for (const placeholder in placeholders) {
        templateContent = templateContent.replace(`{${placeholder}}`, placeholders[placeholder]);
    }

    return templateContent;
}
</script>
{% endblock %}
