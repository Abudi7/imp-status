{% extends 'base.html.twig' %}
{% block body %}
<div class="container">
    <div class="row">
        <main role="main" class="col-md-12 order-md-1 pt-1 px-2">
            <h3 class="text-center rounded-pill bg-info text-white">Systems</h3>
             <div class="alert alert-info">
                <p><strong>Admin Guide:</strong> This page displays the list of systems and their current status.</p>
                <ul>
                    <li><span class="bg-success status-circle"></span> Status: Available</li>
                    <li><span class="bg-warning status-circle"></span> Status: Maintenance</li>
                    <li><span class="bg-danger status-circle"></span> Status: Incident</li>
                </ul>
                <p>You can click on the system's name to view more details. Use the "Activate" and "Deactivate" buttons to control system activation.</p>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-md table-striped" id="table" style="font-size: 13px">
                    <thead class="bg-primary text-white">
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Name</th>
                            <th scope="col">Status</th>
                            <th scope="col">Created at</th>
                            <th scope="col">info</th>
                            <th scope="col">Generated by</th>
                            <th scope="col">Active | Deactive</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% set availableSystems = [] %}
                        {% set maintenanceSystems = [] %}
                        {% set incidentSystems = [] %}

                        {% for system in systems %}
                        {% if system.status == 'available' %}
                        {% set availableSystems = availableSystems|merge([system]) %}
                        {% elseif system.status == 'maintenance' %}
                        {% set maintenanceSystems = maintenanceSystems|merge([system]) %}
                        {% else %}
                        {% set incidentSystems = incidentSystems|merge([system]) %}
                        {% endif %}
                        {% endfor %}

                        {% set sortedSystems = availableSystems|merge(maintenanceSystems)|merge(incidentSystems) %}

                        {% for system in sortedSystems %}
                        <tr>
                            <td>{{ system.id }}</td>
                            <td>
                                <a href="{{ path('app_system_display', {'id': system.id}) }}"
                                    class="btn btn-sm btn-link{{ system.active == 0 ? ' disabled' }}">
                                    {{ system.name }}
                                </a>
                            </td>
                            <td>
                                <div class="status-circle
                        {% if system.status == 'available' %}
                            bg-success
                        {% elseif system.status == 'maintenance' %}
                            bg-warning
                        {% else %}
                            bg-danger
                        {% endif %}
                    "></div>
                                {{ system.status }}
                            </td>
                            <td>{{ system.createdAt|date('Y-m-d H:i:s') }}</td>
                            <td>{{ system.info }}</td>
                            <td>{{ system.creator.username }}</td>
                            <td>
                                <a href="{{ path('app_system', {'system_id': system.id, 'active': system.active ? 0 : 1 }) }}"
                                    class="btn btn-sm btn-link btn-outline-{{ system.active ? 'danger text-danger' : 'primary' }}">
                                    {{ system.active ? 'Deactivate' : 'Activate' }}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>


                {# <!-- Add status script -->
                <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
                <script>
                    document.addEventListener('DOMContentLoaded', function () {
                        const statusCells = document.querySelectorAll('.status-cell');

                        statusCells.forEach(cell => {
                            const systemId = cell.dataset.systemId;
                            fetch(`http://localhost:8080/public/events/get-system-status/${systemId}`) // Update the URL to match your route
                                .then(response => response.json())
                                .then(data => {
                                    const status = data.status;

                                    let bgColorClass = '';
                                    if (status === 'available') {
                                        bgColorClass = 'bg-success';
                                    } else if (status === 'maintenance') {
                                        bgColorClass = 'bg-warning';
                                    } else if (status === 'down') {
                                        bgColorClass = 'bg-danger';
                                    }

                                    // Construct the HTML with status circle and status text on the same line without breaks
                                    const statusHtml = `<div class="status-circle ${bgColorClass}"></div><div style="display: inline">${status}</div>`;
                                    cell.innerHTML = statusHtml; // Set the status HTML in the cell
                                })
                                .catch(error => {
                                    console.error('Error fetching system status:', error);
                                });
                        });
                    });
                </script> #}
        </main>
    </div>
</div>
{% endblock %}